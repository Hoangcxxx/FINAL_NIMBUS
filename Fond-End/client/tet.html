<!DOCTYPE html>
<html lang="en" ng-app="app">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Address Selection</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
</head>

<body ng-controller="AddressController">

    <h2>Select Address</h2>

    <!-- Dropdown Tỉnh -->
    <label for="province">Province</label>
    <select id="province" ng-model="selectedProvince"
        ng-options="province.name for province in provinces track by province.id"
        ng-change="getDistricts(selectedProvince.id)">
        <option value="">Select Province</option>
    </select>

    <!-- Dropdown Huyện -->
    <label for="district">District</label>
    <select id="district" ng-model="selectedDistrict"
        ng-options="district.name for district in districts track by district.id"
        ng-change="getWards(selectedDistrict.id)">
        <option value="">Select District</option>
    </select>

    <!-- Dropdown Xã -->
    <label for="ward">Ward</label>
    <select id="ward" ng-model="selectedWard" ng-options="ward.name for ward in wards track by ward.id">
        <option value="">Select Ward</option>
    </select>

    <!-- Button to save address -->
    <button ng-click="saveAddress()">Save Address</button>

    <script>
        angular.module('app', [])
            .controller('AddressController', function ($scope, $http) {
                // Lấy danh sách tỉnh từ backend
                $http.get('http://127.0.0.1:8080/api/nguoi_dung/address/provinces')
                    .then(function (response) {
                        console.log("Provinces Data:", response.data);
                        $scope.provinces = response.data;  // Gán đúng vào biến $scope.provinces
                    })
                    .catch(function (error) {
                        console.error("Error fetching provinces:", error);
                    });

                // Lấy danh sách huyện theo tỉnh đã chọn
                $scope.getDistricts = function (provinceId) {
                    if (!provinceId) {
                        console.error("Province ID is not selected");
                        return;
                    }

                    // In ra id của tỉnh đã chọn
                    console.log("Selected Province ID:", provinceId);

                    $http.get('http://127.0.0.1:8080/api/nguoi_dung/address/districts/' + provinceId)
                        .then(function (response) {
                            $scope.districts = response.data;
                        })
                        .catch(function (error) {
                            console.error('Có lỗi xảy ra khi lấy huyện:', error);
                        });
                };

                // Lấy danh sách xã theo huyện đã chọn
                $scope.getWards = function (districtId) {
                    if (!districtId) {
                        console.error("District ID is not selected or invalid");
                        return;
                    }

                    $http.get('http://127.0.0.1:8080/api/nguoi_dung/address/wards/' + districtId)
                        .then(function (response) {
                            if (response.data) {
                                $scope.wards = response.data;
                            } else {
                                console.warn("No wards data available");
                            }
                        })
                        .catch(function (error) {
                            console.error("Error fetching wards:", error);
                        });
                };

                // Save address function
                $scope.saveAddress = function () {
                    // Giả sử userId = 1
                    var userId = 1;  // Lấy userId từ nơi bạn lưu trữ, ví dụ: từ session hoặc từ dữ liệu người dùng đã đăng nhập

                    // Lấy các mã thành phố, huyện, xã từ các lựa chọn
                    var cityCode = $scope.selectedProvince ? $scope.selectedProvince.id : null;
                    var districtCode = $scope.selectedDistrict ? $scope.selectedDistrict.id : null;
                    var wardCode = $scope.selectedWard ? $scope.selectedWard.id : null;

                    // Kiểm tra nếu có bất kỳ mã nào chưa được chọn
                    if (!cityCode || !districtCode || !wardCode) {
                        alert("Please select a complete address.");
                        return;
                    }

                    // Gửi request POST với các tham số qua query string
                    $http.post('http://127.0.0.1:8080/api/nguoi_dung/address/save/address', null, {
                        params: {
                            userId: userId,
                            cityCode: cityCode,
                            districtCode: districtCode,
                            wardCode: wardCode
                        }
                    })
                    .then(function (response) {
                        alert("Address saved successfully!");
                    })
                    .catch(function (error) {
                        alert("Error saving address: " + error.data);
                    });
                };
            });
    </script>

</body>

</html>
