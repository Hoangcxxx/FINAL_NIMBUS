<section id="page-header-thanhtoan" class="about-header text-center py-4">
    <!-- <h2>#KnowUs</h2>
    <p>Lorem ipsum dolor sit amet, consectetur</p> -->
</section>

<div class="container my-4">
    <div class="row">
        <!-- Left Column: Shipping and Payment Information -->
        <div class="col-lg-8">
            <h2 class="cart-title text-center mb-4">Thanh Toán</h2>
            <!-- Shipping Information -->
            <div>
                <h5 class="mt-4">Thông tin Giao hàng</h5>
                <form ng-submit="placeOrder()" class="compact-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="email" ng-model="userInfo.email"
                                placeholder="Nhập email" ng-change="autoSave()" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">Họ và tên <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" ng-model="userInfo.tenNguoiDung"
                                placeholder="Nhập họ và tên" ng-change="autoSave()" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="phone" class="form-label">Số điện thoại <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="phone" ng-model="userInfo.sdt"
                                placeholder="Nhập số điện thoại" ng-change="autoSave()" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="address" class="form-label">Địa chỉ cụ thể <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="address" ng-model="userInfo.diaChi"
                                placeholder="Nhập địa chỉ Số nhà" ng-change="autoSave()" required>
                        </div>
                    </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label" for="city">Chọn Tỉnh/Thành phố <span class="text-danger">*</span>:</label>
                    <select class="form-select" ng-model="selectedCity"
                        ng-options="city.name for city in cities track by city.id" ng-change="onCityChange()" required>
                        <option value="">--Chọn Tỉnh/Thành phố--</option>
                    </select>
                </div>

                <div class="col-md-4 mb-3">
                    <label class="form-label" for="district">Chọn Huyện <span class="text-danger">*</span>:</label>
                    <select class="form-select" ng-model="selectedDistrict"
                        ng-options="district.name for district in districts track by district.id"
                        ng-change="onDistrictChange()" ng-disabled="!selectedCity" required>
                        <option value="">--Chọn Huyện--</option>
                    </select>
                </div>

                <div class="col-md-4 mb-3">
                    <label class="form-label" for="ward">Chọn Xã/Phường <span class="text-danger">*</span>:</label>
                    <select class="form-select" ng-model="selectedWard"
                        ng-options="ward.name for ward in wards track by ward.id" ng-disabled="!selectedDistrict"
                        ng-change="calculateShippingFee()" required>
                        <option value="">--Chọn Xã/Phường--</option>
                    </select>
                </div>
            </div>

            <div class="mb-3">
                <label for="note" class="form-label">Ghi chú</label>
                <textarea class="form-control" id="note" ng-model="shippingInfo.note" rows="2"
                    placeholder="Ghi chú"></textarea>
            </div>
            </form>


            <!-- Payment Method -->
            <h5 class="mt-4">Phương thức Thanh toán</h5>
            <div class="card p-3 mb-4">
                <label for="paymentMethod" class="form-label">Chọn phương thức thanh toán</label>
                <div class="form-check">
                    <input class="form-check-input" ng-model="selectedPaymentMethod" type="radio" name="payment"
                        id="cod" value="cod">
                    <label class="form-check-label" for="cod">
                        <i class="fas fa-truck"></i> Thanh toán khi giao hàng (COD)
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" ng-model="selectedPaymentMethod" type="radio" name="payment"
                        id="vnpay" value="vnpay">
                    <label class="form-check-label" for="vnpay">
                        <i class="fas fa-mobile-alt"></i> VNPay
                    </label>
                </div>
                <!-- <div class="form-check">
                    <input class="form-check-input" ng-model="selectedPaymentMethod" type="radio" name="payment"
                        id="mbbank" value="mbbank">
                    <label class="form-check-label" for="mbbank">
                        <i class="fas fa-mobile-alt"></i> MBBANK
                    </label>
                </div> -->
                <small class="text-muted d-block mt-2">
                    Bạn chỉ phải thanh toán khi nhận được hàng với COD, hoặc thanh toán qua ứng dụng ZaloPay và VNPay.
                </small>
            </div>

        </div>

        <!-- Right Column: Order Summary -->
        <div class="col-lg-4">
            <div class="summary-box p-4 shadow-sm rounded">
                <h5>Đơn hàng ({{ cart.length }} sản phẩm)</h5>
                <div ng-repeat="item in cart" class="d-flex align-items-center mb-3">
                    <img ng-src="{{item.urlAnh}}" alt="Hình ảnh sản phẩm" class="img-thumbnail me-2"
                        style="width: 80px; height: 80px;">
                    <div class="flex-grow-1">
                        <h6>{{item.tenSanPham}}</h6>

                        <p class="mb-1">
                            Giá: <!-- Hiển thị giá khuyến mãi nếu có và giá không null -->
                            <!-- Hiển thị giá khuyến mãi -->
                            <span ng-if="item.kieuGiamGia && item.giaKhuyenMai != null" class="text-danger mb-2"
                                style="font-size: 1rem; font-weight: bold;">
                                {{ item.giaKhuyenMai | currency: '':0 }} VND
                            </span>
                            <!-- Hiển thị giá gốc bị gạch ngang -->
                            <span ng-if="item.kieuGiamGia && item.giaKhuyenMai != null"
                                style="font-size: 0.8rem; color: #999;">
                                <del>{{ item.giaBan | currency: '':0 }} VND</del>
                            </span>

                            <!-- Nếu không có giảm giá hoặc giá khuyến mãi null, chỉ hiển thị giá gốc -->

                            <span ng-if="!item.kieuGiamGia || item.giaKhuyenMai == null"
                                style="font-size: 1rem; font-weight: bold;">
                                {{ item.giaBan | currency: '': 0 }} VND
                            </span>
                        </p>
                        <p class="mb-1">Số lượng: {{item.soLuongGioHang}}</p>
                    </div>
                </div>
                <hr>

                <!-- Test phiếu giảm giá -->
                <button data-bs-toggle="modal" data-bs-target="#voucherModal" ng-click="dsvoucher()"
                    class="btn btn-warning w-100">Áp dụng mã khuyến mãi</button>
                <hr>

                <div class="mb-3" ng-if="selectedVoucher">
                    <div class="voucher-info"
                        style="position: relative; border-radius: 10px; padding: 20px; background-color: #fff; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin: 20px 0;">
                        <!-- Icon "X" để hủy voucher -->
                        <i class="fas fa-times"
                            style="position: absolute; top: 10px; right: 10px; font-size: 1.5em; color: #ff0000; cursor: pointer;"
                            ng-click="removeVoucher()"></i>
                        <div class="voucher-header"
                            style="display: flex; align-items: center; border-bottom: 2px solid #ff0000; padding-bottom: 10px; margin-bottom: 10px;">
                            <i class="fas fa-tags" style="font-size: 1.5em; color: #ff0000; margin-right: 10px;"></i>
                            <h2 style="font-size: 1.5em; color: #333;">
                                Voucher áp dụng:
                                <strong>{{ selectedVoucher.maVoucher }}</strong>
                            </h2>
                        </div>
                        <div class="voucher-details"
                            style="background-color: #f9f9f9; border-radius: 5px; padding: 15px; border-left: 5px solid #ff0000;">
                            <p class="voucher-description" style="font-size: 1em; color: #666; margin: 0;">
                                {{ selectedVoucher.moTa }}
                            </p>
                        </div>
                    </div>
                </div>


                <div class="d-flex justify-content-between">
                    <span>Tạm tính:</span>
                    <!-- Hiển thị tổng tiền sản phẩm theo giá bán cơ bản -->
                    <span>{{ totalProductPrice | currency: '' : 0 }} VND</span>
                </div>
                
                <div class="d-flex justify-content-between">
                    <label>Số tiền giảm giá:</label>
                    <div>
                        <span ng-if="selectedVoucher" class="text-danger">
                            <span>
                                - {{ discountAmount | currency: '' : 0 }} VND
                            </span>
                        </span>
                        <span ng-if="!selectedVoucher">Chưa chọn voucher</span>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between">
                    <label>Số tiền sau giảm giá:</label>
                    <div>
                        <span ng-if="selectedVoucher">
                            <span>
                                {{ (totalProductPrice - discountAmount > 0 ? totalProductPrice - discountAmount : 0) | currency: '' : 0 }} VND
                            </span>
                        </span>
                        <span ng-if="!selectedVoucher">Chưa chọn voucher</span>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between">
                    <div>Phí vận chuyển:</div>
                    <div>
                        <span ng-if="shippingFee && shippingFee > 0">
                            {{ shippingFee | currency: '' : 0 }} VND
                        </span>
                        <span ng-if="!shippingFee || shippingFee <= 0">
                            0
                        </span>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between mt-2 align-items-center" style="font-size: 25px;">
                    <strong>Tổng tiền:</strong>
                    <!-- Hiển thị tổng tiền sau khuyến mãi cộng với phí ship -->
                    <strong>{{ totalDiscountedPrice | currency: '' : 0 }} VND</strong>
                </div>
                
                <p class="mt-4 text-muted small">
                    Sau khi "Đặt hàng" thành công, Nimbus sẽ liên hệ xác nhận đơn hàng theo số Hotline 02836220632.
                </p>

                <button ng-click="placeOrder()" class="btn btn-success w-100" >Đặt
                    hàng</button>

            </div>
        </div>
    </div>
</div>











<!-- Modal chọn voucher -->
<div class="modal fade" id="voucherModal" tabindex="-1" aria-labelledby="voucherModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content rounded-5 shadow-lg"
            style="border: none; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);">
            <div class="modal-header" style="background: linear-gradient(to right, #00bcd4, #f32121); color: white;">
                <h5 class="modal-title" id="voucherModalLabel" style="font-weight: 700; font-size: 1.25rem;">Chọn hoặc
                    Nhập Voucher
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Nhập mã giảm giá -->
                <div class="mb-4">
                    <label for="voucherCodeInput" class="form-label" style="font-weight: 600; color: #333;">Nhập mã giảm
                        giá:</label>
                    <div class="input-group">
                        <input type="text" id="voucherCodeInput" class="form-control"
                            style="border-radius: 12px; border: 1px solid #ccc; transition: border-color 0.3s ease, box-shadow 0.3s ease;"
                            placeholder="Nhập mã giảm giá tại đây" ng-model="voucherCode" />
                        <button class="btn"
                            style="background: linear-gradient(90deg, #28a745, #218838); color: white; border: none; transition: background 0.3s ease;"
                            ng-click="applyVoucher()">Áp dụng mã</button>
                    </div>
                    <!-- <div class="text-danger mt-2" ng-if="voucherError" style="font-size: 0.875rem; color: #e74c3c;">{{
                        voucherError }}
                    </div> -->
                </div>

                <hr class="my-4" style="border-top: 1px solid #ddd;" />


                <div>
                    <h5 class="fw-semibold" style="font-size: 1.1rem; color: #333;">Danh
                        sách voucher khả dụng:</h5>
                    <div class="list-group" style="max-height: 500px; overflow-y: auto;">
                        <button type="button" class="list-group-item list-group-item-action p-4 mb-3 rounded-3"
                            ng-repeat="voucher in Voucher" ng-click="selectVoucher(voucher)" ng-style="{
                                                'opacity': voucher.isUsable ? '1' : '0.5', 
                                                'pointer-events': voucher.isUsable ? 'auto' : 'none', 
                                                'cursor': voucher.isUsable ? 'pointer' : 'not-allowed'
                                            }">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong class="text-dark" style="font-size: 1.1rem;">{{voucher.maVoucher}}</strong>
                                    - {{ voucher.moTa }}
                                </div>
                                <span class="badge" ng-style="{
                                                'background': voucher.isUsable ? 'linear-gradient(to right, #28a745, #218838)' : '#e74c3c',
                                                'color': 'white',
                                                'font-size': '14px',
                                                'font-weight': '600',
                                                'border-radius': '15px',
                                                'padding': '5px 10px'
                                            }">
                                    {{ voucher.trangThaiGiamGia.tenTrangThaiGiamGia }}
                                </span>
                            </div>

                            <!-- Hiển thị thông tin chi tiết về giá tiền -->
                            <div style="margin-top: 15px; font-size: 1rem; color: #555;">
                                <p>
                                    <strong>Giảm giá:</strong>
                                    <span style="color: #e74c3c; font-weight: bold;">
                                        <span ng-if="voucher.kieuGiamGia">
                                            {{ voucher.giaTriGiamGia | currency:"":0 }} VND
                                        </span>
                                        <span ng-if="!voucher.kieuGiamGia">
                                            {{ voucher.giaTriGiamGia | currency:"":0 }} %
                                        </span>
                                    </span>
                                </p>
                                <p>
                                    <strong>Áp dụng cho đơn hàng từ:</strong>
                                    <span>{{ voucher.soTienToiThieu | currency:"":0 }} VND</span>

                                    <span ng-if="voucher.kieuGiamGia === false">
                                        đến
                                        <span>{{ voucher.giaTriToiDa | currency:"":0 }} VND</span>
                                    </span>

                                    <span ng-if="voucher.kieuGiamGia === true">
                                        trở lên
                                    </span>
                                </p>
                            </div>
                            <div ng-if="voucher.isUsable" style="color: #28a745; font-weight: bold; font-size: 14px;">
                                <i class="fas fa-check-circle" style="color: #28a745; margin-right: 5px;"></i>Có thể
                                sử
                                dụng
                            </div>
                            <div ng-if="!voucher.isUsable" style="color: #e74c3c; font-weight: bold; font-size: 14px;">
                                <i class="fas fa-times-circle" style="color: #e74c3c; margin-right: 5px;"></i>Không
                                thể
                                sử dụng
                            </div>
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Vô hiệu hóa toàn bộ giao diện ngoài phần thông báo */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999;
        display: none;
        /* Ẩn mặc định */
    }
</style>